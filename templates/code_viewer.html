<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    
    <style>
        body {
            font-family: monospace;
            background-color: #24292e;
            color: #d1d5da;
            margin: 0;
            padding: 20px;
            overflow-x: hidden; 
        }
        
        /* Controls (Fixed position) */
        .controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        .controls button {
            background-color: #0366d6;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 6px;
        }
        
        /* üöÄ ‡¶Æ‡ßÇ‡¶≤ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞: ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã */
        #code-container {
            background-color: #0d1117;
            border-radius: 6px;
            overflow-x: auto; 
            margin-top: 10px;
            
            display: grid;
            grid-template-columns: 1fr; /* üõë ‡¶≤‡¶æ‡¶á‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ö‡¶™‡¶∏‡¶æ‡¶∞‡¶£‡ßá‡¶∞ ‡¶™‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® */
        }

        /* üõë ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶≠‡¶æ‡¶¨‡ßá .line-numbers CSS ‡¶¨‡ßç‡¶≤‡¶ï‡¶ü‡¶ø ‡¶∏‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡¶≤‡ßã */

        /* ‡¶ï‡ßã‡¶° ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ */
        pre {
            grid-column: 1; /* ‡¶è‡¶ñ‡¶® ‡¶ï‡¶≤‡¶æ‡¶Æ ‡ßß ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá */
            margin: 0;
            padding: 20px;
            overflow-x: auto;
            white-space: pre-wrap; 
            word-wrap: break-word; 
        }
        
        /* highlight.js output adjustments */
        pre code.hljs {
            display: block;
            padding: 0 !important; 
        }

        /* Highlighted search result */
        .highlight {
            background-color: rgba(255, 255, 0, 0.5);
            color: black;
            font-weight: bold;
        }
        /* ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶π‡¶æ‡¶á‡¶≤‡¶æ‡¶á‡¶ü ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
        .first-highlight {
            box-shadow: 0 0 10px 2px rgba(255, 165, 0, 0.8);
            border: 1px solid orange; 
        }
        
        /* üöÄ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤: Word/Plain Text Title */
        h4#file-title {
            color: #6a737d;
            margin-bottom: 5px;
            padding: 0 20px;
        }
    </style>
</head>
<body>
    
    {% if filename %}
    <h4 id="file-title">Text View for: {{ filename }}</h4>
    {% endif %}
    
    <div class="controls">
        <button id="saveFileBtn">Save File</button>
    </div>
    
    <div id="code-container">
        {% if preloaded_content is not none %}
            <pre><code id="file-content" class="hljs language-plaintext">{{ preloaded_content }}</code></pre>
        {% else %}
            <div id="loading-message">Loading file content...</div>
        {% endif %}
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        
        const fileId = '{{ file_id }}';
        const query = {{ query | tojson }}; 
        
        const codeContainer = document.getElementById('code-container');
        let fileContentEl = document.getElementById('file-content'); // codeTag ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§ ‡¶π‡¶Ø‡¶º
        const saveFileBtn = document.getElementById('saveFileBtn');
        
        let initialContentLoaded = fileContentEl && fileContentEl.textContent.trim().length > 0;
        let decodedFilename = 'downloaded_file';
        let isTextViewer = window.location.pathname.includes('/view_text/');

        // üöÄ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï: ‡¶Ø‡¶¶‡¶ø preloaded_content ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá API ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
        if (!initialContentLoaded) {
             const loadingMessage = document.getElementById('loading-message');
             if (loadingMessage) loadingMessage.textContent = 'Loading file content... (This may take a moment for large files)';

            const response = await fetch(`/get_file/${fileId}`);
            
            if (response.ok) {
                const text = await response.text();
                
                // ‡¶´‡¶æ‡¶á‡¶≤‡¶®‡ßá‡¶Æ ‡¶°‡¶ø‡¶ï‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
                const contentDisposition = response.headers.get('Content-Disposition');
                const filenameMatch = contentDisposition.match(/filename\*=UTF-8''([^;"]+)"?/);

                if (filenameMatch && filenameMatch[1]) {
                    decodedFilename = decodeURIComponent(filenameMatch[1]);
                } else {
                    const plainFilenameMatch = contentDisposition.match(/filename="([^;"]+)"/);
                    decodedFilename = plainFilenameMatch ? plainFilenameMatch[1] : 'downloaded_file';
                }
                
                const standardizedText = text.replace(/\r\n|\r/g, '\n'); 
                
                codeContainer.innerHTML = ''; 

                const preElement = document.createElement('pre');
                preElement.id = 'code-block';
                const codeTag = document.createElement('code');
                codeTag.id = 'file-content';
                
                // ‡¶Ø‡¶¶‡¶ø view_text ‡¶π‡¶Ø‡¶º ‡¶§‡¶¨‡ßá plaintext, ‡¶Ö‡¶®‡ßç‡¶Ø‡¶•‡¶æ‡¶Ø‡¶º hljs default ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
                codeTag.className = isTextViewer ? 'hljs language-plaintext' : 'hljs'; 
                
                codeTag.textContent = standardizedText; 
                preElement.appendChild(codeTag);

                codeContainer.appendChild(preElement);
                fileContentEl = codeTag;
                
                initialContentLoaded = true;
            } else {
                 codeContainer.innerHTML = `<div style="padding: 20px; color: red;">Failed to load file content: ${response.statusText}. Please check the server logs.</div>`;
                 return;
            }
        }
        
        if (initialContentLoaded) {
             const contentElement = fileContentEl;
             
             // üöÄ ‡¶ß‡¶æ‡¶™ ‡ßß: ‡¶Ø‡¶¶‡¶ø /view_text/ ‡¶∞‡ßÅ‡¶ü‡ßá ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶∏‡¶ø‡¶®‡¶ü‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏ ‡¶π‡¶æ‡¶á‡¶≤‡¶æ‡¶á‡¶ü‡¶ø‡¶Ç ‡¶è‡¶°‡¶º‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶® (‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶™‡ßç‡¶≤‡ßá‡¶á‡¶® ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶Æ‡ßã‡¶°)
             if (!isTextViewer) {
                 hljs.highlightElement(contentElement);
             }


            let firstHighlightElement = null;

            // üöÄ ‡¶ß‡¶æ‡¶™ ‡ß®: ‡¶π‡¶æ‡¶á‡¶≤‡¶æ‡¶á‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤ ‡¶≤‡¶ú‡¶ø‡¶ï (TreeWalker ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá)
            if (query) {
                const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                let foundFirst = false;

                const walker = document.createTreeWalker(
                    contentElement, 
                    NodeFilter.SHOW_TEXT, 
                    null, 
                    false
                );

                let node;
                while (node = walker.nextNode()) {
                    // ‡¶ï‡ßã‡¶° ‡¶¨‡ßç‡¶≤‡¶ï ‡¶¨‡¶æ ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶è ‡¶π‡¶æ‡¶á‡¶≤‡¶æ‡¶á‡¶ü ‡¶è‡¶°‡¶º‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ
                    if (node.parentElement && (node.parentElement.classList.contains('highlight') || node.parentElement.closest('.hljs-comment'))) {
                        continue; 
                    }
                    
                    const parentNode = node.parentNode;
                    let match;
                    
                    while (match = regex.exec(node.nodeValue)) {
                        const matchText = match[0];
                        
                        const highlightSpan = document.createElement('span');
                        highlightSpan.className = 'highlight';

                        if (!foundFirst) {
                            highlightSpan.classList.add('first-highlight');
                            highlightSpan.id = 'search-target';
                            foundFirst = true;
                        }
                        
                        const preMatchText = node.nodeValue.substring(0, match.index);
                        if (preMatchText) {
                            parentNode.insertBefore(document.createTextNode(preMatchText), node);
                        }
                        
                        highlightSpan.textContent = matchText;
                        parentNode.insertBefore(highlightSpan, node);
                        
                        node.nodeValue = node.nodeValue.substring(match.index + matchText.length);
                        
                        regex.lastIndex = 0; 
                        
                        if (!firstHighlightElement) {
                            firstHighlightElement = highlightSpan;
                        }
                    }
                }
            }


            // üõë ‡¶ß‡¶æ‡¶™ ‡ß©: ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤ ‡¶≤‡¶ú‡¶ø‡¶ï
            if (firstHighlightElement) {
                // DOM ‡¶™‡ßÅ‡¶∞‡ßã‡¶™‡ßÅ‡¶∞‡¶ø ‡¶∏‡ßá‡¶ü ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶õ‡ßã‡¶ü ‡¶°‡¶ø‡¶≤‡ßá
                setTimeout(() => {
                    firstHighlightElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start' 
                    });
                    
                    firstHighlightElement.removeAttribute('id');
                }, 50); 
            }
            
            // Save button logic (unchanged)
            saveFileBtn.addEventListener('click', () => {
                const link = document.createElement('a');
                link.href = window.location.origin + `/get_file/${fileId}`;
                // ‡¶Ø‡¶¶‡¶ø filename ‡¶™‡ßç‡¶∞‡¶ø‡¶≤‡ßã‡¶°‡ßá‡¶° ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá (‡¶Ø‡ßá‡¶Æ‡¶®, /view_code/ ‡¶è), ‡¶§‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                link.download = '{{ filename if filename else "" }}' || decodedFilename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            // Copy logic (unchanged from your last version)
            document.addEventListener('copy', (event) => {
                 const selection = window.getSelection();
                 let selectedText = selection.toString();
                 event.clipboardData.setData('text/plain', selectedText);
                 event.preventDefault();
            });
        }
    });
    </script>
</body>
</html>